<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3-Day Rolling Average Nutrition Tracker</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .progress-bar-bg { background-color:#e0e0e0; }
    .progress-bar-fill { transition: width .5s ease-in-out; }
    .nutrient-card { transition: all .3s ease-in-out; }
    .nutrient-card:hover { transform: translateY(-5px); box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background:#f1f1f1; }
    ::-webkit-scrollbar-thumb { background:#888;border-radius:10px; }
    ::-webkit-scrollbar-thumb:hover { background:#555;border-radius:10px; }
    .chart-container { position:relative;height:400px;margin:20px 0; }
    .food-dropdown { position:relative; }
    .food-dropdown-list{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #d1d5db; border-top:none; border-radius:0 0 .375rem .375rem; max-height:200px; overflow-y:auto; z-index:10; box-shadow:0 10px 15px -3px rgba(0,0,0,.1);}
    .food-dropdown-item{ padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6; transition:background-color .2s;}
    .food-dropdown-item:hover{ background-color:#f3f4f6;}
    .food-dropdown-item:last-child{ border-bottom:none;}
    .food-dropdown-item.highlighted{ background-color:#eff6ff;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <nav class="p-2 text-sm"><a href="/" class="text-blue-600 hover:underline">Back to Hub</a></nav>

  <!-- App -->
  <script type="module">
    // =========================
    // ===== CONFIGURATION =====
    // =========================
    const CONFIG = {
      TIMEZONE: 'America/Chicago',
      DEFAULT_CHART_NUTRIENT: 'calories',
      DEFAULT_CHART_TIMEFRAME: 'week',
      DEFAULT_FAT_MINIMUM: 50,
      CHART_COLORS: ['#3B82F6','#EF4444','#10B981','#F59E0B','#8B5CF6','#EC4899','#06B6D4','#84CC16'],
      CHART_AVERAGE_LOOKBACK: 3,
      SEARCH_MIN_CHARS: 1,
      SEARCH_DEBOUNCE_MS: 300,
      MAX_DROPDOWN_ITEMS: 10,
      DEBUG_MODE: true,
      ANIMATION_DURATION: 300
    };

    // Canvas globals if present
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // ---- Firebase config (Cloudflare hosting: load from local firebaseConfig.js) ----
    // This assumes a file at /firebaseConfig.js that exports: export const firebaseConfig = { ... }
    import { firebaseConfig as importedConfig } from './firebaseConfig.js';
    
    const firebaseConfig = importedConfig;
    
    if (!firebaseConfig || !firebaseConfig.apiKey) {
      throw new Error('firebaseConfig.js is present but missing required keys (e.g., apiKey).');
    }
    if (CONFIG.DEBUG_MODE) console.log('âœ… Firebase config loaded from ./firebaseConfig.js');


    // ======================
    // ===== FIREBASE =======
    // ======================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, getDocs, query, orderBy, limit, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ======================
    // ===== APP STATE ======
    // ======================
    let userId;
    let baselineTargets = {};
    let dailyEntries = new Map();
    let chartInstance = null;
    let dailyFoodItems = [];
    let savedFoodItems = new Map();
    let foodDropdownVisible = false;
    let searchTimeout = null;
    let selectedDropdownIndex = -1;

    // DOM cache (assigned after DOM is ready)
    let settingsModal, loginModal, foodManagerModal, duplicateFoodModal, blankFoodNameModal;
    let dateInput, dashboard, loader, mainContent, messageBox, messageText, userStatus;
    let confirmationModal, confirmationMessage, confirmActionButton, cancelActionButton, promptInput, promptInputContainer;

    function cacheDom() {
      settingsModal = document.getElementById('settings-modal');
      loginModal = document.getElementById('login-modal');
      foodManagerModal = document.getElementById('food-manager-modal');
      duplicateFoodModal = document.getElementById('duplicate-food-modal');
      blankFoodNameModal = document.getElementById('blank-food-name-modal');

      dateInput = document.getElementById('date-input');
      dashboard = document.getElementById('dashboard');
      loader = document.getElementById('loader');
      mainContent = document.getElementById('main-content');
      messageBox = document.getElementById('message-box');
      messageText = document.getElementById('message-text');
      userStatus = document.getElementById('user-status');

      confirmationModal = document.getElementById('confirmation-modal');
      confirmationMessage = document.getElementById('confirmation-message');
      confirmActionButton = document.getElementById('confirm-action-btn');
      cancelActionButton = document.getElementById('cancel-action-btn');
      promptInput = document.getElementById('prompt-input');
      promptInputContainer = document.getElementById('prompt-input-container');
    }

    // ==========================
    // ===== NUTRIENT LISTS =====
    // ==========================
    const nutrients = {
      macros: ['calories','protein','carbs','fat'],
      vitaminsDaily: ['vitaminB12','folate','vitaminC','vitaminB6'],
      vitaminsAvg: ['vitaminA','vitaminD','vitaminE','vitaminK'],
      mineralsDaily: ['iron','calcium','magnesium','zinc','potassium','sodium'],
      mineralsAvg: ['selenium','iodine','phosphorus'],
      optional: ['omega3','fiber','choline']
    };
    const allNutrients = [
      ...nutrients.macros, ...nutrients.vitaminsDaily, ...nutrients.vitaminsAvg,
      ...nutrients.mineralsDaily, ...nutrients.mineralsAvg, ...nutrients.optional
    ];
    const dailyTrackedNutrients = ['protein', ...nutrients.vitaminsDaily, ...nutrients.mineralsDaily];

    // ==========================
    // ====== UTILITIES =========
    // ==========================
    const formatDate = (date) => date.toISOString().split('T')[0];
    const getTodayInTimezone = () => {
      try { return new Date().toLocaleDateString('en-CA', { timeZone: CONFIG.TIMEZONE }); }
      catch (e){ debugLog('timezone-error','Fallback to local', e); return formatDate(new Date()); }
    };
    const getPastDate = (date, days) => {
      const d = new Date(date);
      d.setDate(d.getDate() - days);
      return d;
    };
    const debugLog = (ctx, msg, data=null) => { if (CONFIG.DEBUG_MODE) console.log(`[NUTRITION-TRACKER][${ctx}]`, msg, data||''); };
    const showMessage = (text, isError=false, duration=5000) => {
      if (messageText && messageBox) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden','bg-green-500','bg-red-500');
        messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
        setTimeout(()=> messageBox.classList.add('hidden'), duration);
      }
    };
    const handleError = (ctx, err, userMsg='An error occurred') => {
      console.error(`[NUTRITION-TRACKER][ERROR][${ctx}]`, err);
      showMessage(userMsg, true);
      return null;
    };
    const formatNutrientName = (name) =>
      name.replace(/([A-Z])/g,' $1').trim()
          .replace(/^vitamin/i,'Vitamin ')
          .replace(/^omega/i,'Omega-');
    const getFatMinimum = () => parseFloat(baselineTargets.fatMinimum) || CONFIG.DEFAULT_FAT_MINIMUM;

    function ensureDateInput() {
      if (!dateInput.value) dateInput.value = getTodayInTimezone();
    }

    // ==========================
    // ======= MODALS ===========
    // ==========================
    function showConfirmationModal(message, onConfirm, onCancel=null, isPrompt=false, defaultValue='') {
      if (!confirmationModal) return;
      confirmationMessage.textContent = message;
      promptInput.value = defaultValue;
      if (isPrompt) { promptInputContainer.classList.remove('hidden'); promptInput.focus(); }
      else { promptInputContainer.classList.add('hidden'); }

      confirmationModal.classList.remove('hidden');

      const handleConfirmClick = () => {
        const value = isPrompt ? promptInput.value.trim() : null;
        onConfirm(value);
        confirmationModal.classList.add('hidden');
        confirmActionButton.removeEventListener('click', handleConfirmClick);
        cancelActionButton.removeEventListener('click', handleCancelClick);
      };
      const handleCancelClick = () => {
        if (onCancel) onCancel();
        confirmationModal.classList.add('hidden');
        confirmActionButton.removeEventListener('click', handleConfirmClick);
        cancelActionButton.removeEventListener('click', handleCancelClick);
      };

      confirmActionButton.addEventListener('click', handleConfirmClick);
      cancelActionButton.addEventListener('click', handleCancelClick);
    }

    // ==========================
    // ===== FIREBASE CRUD ======
    // ==========================
    async function saveTargets(targets){
      if (!userId) return showMessage('Cannot save targets. Not authenticated.', true);
      try {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/targets/baseline`), targets);
        baselineTargets = targets;
        showMessage('Targets saved successfully!');
        updateDashboard(); updateChart();
      } catch (e){ handleError('targets-save', e, 'Failed to save targets.'); }
    }

    async function fetchTargets(){
      if (!userId) return {};
      try {
        const ref = doc(db, `artifacts/${appId}/users/${userId}/targets/baseline`);
        const snap = await getDoc(ref);
        const res = snap.exists() ? snap.data() : {};
        debugLog('targets-fetch','ok',{count:Object.keys(res).length});
        return res;
      } catch (e){ return handleError('targets-fetch', e) || {}; }
    }

    async function saveDailyEntry(dateStr, entry){
      if (!userId) return showMessage('Cannot save entry. Not authenticated.', true);
      try {
        entry.foodItems = dailyFoodItems;
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/dailyEntries`, dateStr), entry);
        dailyEntries.set(dateStr, entry);
        showMessage(`Entry for ${dateStr} saved!`);
        updateDashboard(); updateChart(); updateFoodItemsList();
      } catch (e){ handleError('daily-entry-save', e, 'Failed to save entry.'); }
    }

    async function fetchAllEntries(){
      if (!userId) return [];
      const rows = [];
      try {
        const qy = query(collection(db, `artifacts/${appId}/users/${userId}/dailyEntries`), orderBy('date','asc'));
        const qs = await getDocs(qy);
        qs.forEach(d => rows.push(d.data()));
      } catch (e){ handleError('fetch-all-entries', e); }
      return rows;
    }

    async function fetchRecentEntries(){
      if (!userId) return new Map();
      const map = new Map();
      try {
        const qy = query(collection(db, `artifacts/${appId}/users/${userId}/dailyEntries`), orderBy('date','desc'), limit(365));
        const qs = await getDocs(qy);
        qs.forEach(d => map.set(d.id, d.data()));
      } catch (e){ handleError('fetch-recent-entries', e); }
      return map;
    }

    async function loadSavedFoodItems(){
      if (!userId) return;
      try {
        const qy = query(collection(db, `artifacts/${appId}/users/${userId}/foodItems`), orderBy('name'));
        const qs = await getDocs(qy);
        savedFoodItems.clear();
        qs.forEach(d => savedFoodItems.set(d.id, d.data()));
      } catch (e){ handleError('load-saved-foods', e); }
    }

    async function deleteFoodItem(foodId){
      if (!userId) throw new Error('User not authenticated');
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/foodItems`, foodId));
        savedFoodItems.delete(foodId);
      } catch (e){ handleError('delete-food-item', e, 'Failed to delete food item from database'); throw e; }
    }

    // ==========================
    // ===== DATA LOADING =======
    // ==========================
    async function loadUserData(){
      if (!userId){ debugLog('load-user-data','no user'); return; }
      if (!dateInput) cacheDom();
      ensureDateInput();

      mainContent.classList.add('hidden');
      loader.classList.remove('hidden');

      try{
        baselineTargets = await fetchTargets();
        dailyEntries = await fetchRecentEntries();
        await loadSavedFoodItems();
        loadDailyFoodItems();
        populateSettingsForm();
        updateDashboard();
        updateChart();
      } catch(e){ handleError('load-user-data', e, 'Error loading data. Please refresh and try again.'); }

      loader.classList.add('hidden');
      mainContent.classList.remove('hidden');
    }

    // ==========================
    // ===== AUTH / UI ==========
    // ==========================
    function updateAuthStateUI(user){
      if (!loginModal) cacheDom(); // ensure DOM refs exist
      if (user){
        loginModal.classList.add('hidden');
        document.getElementById('open-login-btn').classList.add('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        userStatus.classList.remove('hidden');
        userStatus.textContent = user.isAnonymous ? `Logged in as Guest (ID: ${userId.substring(0,8)}...)` : user.email;
      } else {
        mainContent.classList.add('hidden');
        loader.classList.add('hidden');
        loginModal.classList.remove('hidden');
        document.getElementById('open-login-btn').classList.remove('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
        userStatus.classList.add('hidden');
        userStatus.textContent = '';
      }
    }

    onAuthStateChanged(auth, async (user)=>{
      if (!dateInput) cacheDom();
      ensureDateInput();
      if (user){
        userId = user.uid;
        updateAuthStateUI(user);
        loadUserData();
      } else {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token){
          try { await signInWithCustomToken(auth, __initial_auth_token); }
          catch (error){
            console.error('Custom token sign-in failed; falling back to anonymous', error);
            try { await signInAnonymously(auth); }
            catch (anonError){ handleError('auth-anon-fallback', anonError, 'Failed to sign in anonymously.'); userId = null; updateAuthStateUI(null); }
          }
        } else {
          try { await signInAnonymously(auth); }
          catch (anonError){ handleError('auth-anon-initial', anonError, 'Failed to sign in anonymously.'); userId = null; updateAuthStateUI(null); }
        }
      }
    });

    async function handleSignUp(){
      const email = document.getElementById('email-input').value.trim();
      const password = document.getElementById('password-input').value;
      if (!email || !password) return showMessage('Please enter both email and password.', true);
      if (password.length < 6) return showMessage('Password should be at least 6 characters long.', true);
      try { await createUserWithEmailAndPassword(auth, email, password); showMessage('Account created successfully!'); }
      catch (e){
        const message = e.code==='auth/email-already-in-use' ? 'This email address is already in use by another account.' : e.message;
        handleError('auth-signup', e, message);
      }
    }
    async function handleLogin(){
      const email = document.getElementById('email-input').value.trim();
      const password = document.getElementById('password-input').value;
      if (!email || !password) return showMessage('Please enter both email and password.', true);
      try { await signInWithEmailAndPassword(auth, email, password); showMessage('Logged in successfully!'); }
      catch (e){
        const message = ['auth/invalid-credential','auth/wrong-password','auth/user-not-found'].includes(e.code)
          ? 'Incorrect email or password. Please try again.' : e.message;
        handleError('auth-login', e, message);
      }
    }
    async function handleGuestLogin(){
      try { await signInAnonymously(auth); showMessage('Continuing as a guest. Data is saved to this browser only.'); }
      catch (e){ handleError('auth-guest', e, 'Could not sign in as guest.'); }
    }
    async function handleLogout(){
      try {
        await signOut(auth);
        baselineTargets = {};
        dailyEntries.clear();
        dailyFoodItems = [];
        savedFoodItems.clear();
        if (dashboard) dashboard.innerHTML = '';
        if (chartInstance){ chartInstance.destroy(); chartInstance = null; }
        showMessage('You have been logged out.');
      } catch (e){ handleError('auth-logout', e, 'Failed to log out.'); }
    }

    // ==========================
    // ===== FOOD MANAGER =======
    // ==========================
    function loadDailyFoodItems(){
      const dateStr = dateInput.value;
      const entry = dailyEntries.get(dateStr) || {};
      dailyFoodItems = entry.foodItems || [];
      updateFoodItemsList();
    }

    function updateFoodItemsList(){
      const container = document.getElementById('food-items-list');
      if (!container) return;
      if (dailyFoodItems.length === 0){
        container.innerHTML = '<p class="text-gray-500 text-sm">No food items logged yet for this day.</p>';
        return;
      }
      container.innerHTML = dailyFoodItems.map((item, index)=> {
        const name = item.name || '(blank)';
        return `
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
            <span class="text-sm">
              <strong>${name}:</strong>
              Cal: ${item.calories||0} | P: ${item.protein||0} / C: ${item.carbs||0} / F: ${item.fat||0}
            </span>
            <button onclick="removeFoodItem(${index})" class="text-red-500 hover:text-red-700 text-xs">
              <i class="fas fa-times"></i>
            </button>
          </div>`;
      }).join('');
    }

    function clearStagingArea(){
      allNutrients.forEach(n => { const input = document.getElementById(`actual-${n}`); if (input) input.value = ''; });
      const pa = document.getElementById('paste-area'); if (pa) pa.value = '';
      const fi = document.getElementById('food-item-input'); if (fi) fi.value = '';
    }

    // Search dropdown
    function setupFoodDropdown(){
      const foodInput = document.getElementById('food-item-input');
      const dropdownContainer = document.getElementById('food-dropdown');
      if (!foodInput || !dropdownContainer) return;

      foodInput.addEventListener('input', (e)=>{
        clearTimeout(searchTimeout);
        const value = e.target.value.trim();
        searchTimeout = setTimeout(()=>{
          if (value.length >= CONFIG.SEARCH_MIN_CHARS) performFoodSearch(value);
          else hideFoodDropdown();
        }, CONFIG.SEARCH_DEBOUNCE_MS);
      });

      foodInput.addEventListener('keydown', (e)=>{
        if (!foodDropdownVisible) return;
        const items = dropdownContainer.querySelectorAll('.food-dropdown-item');
        switch (e.key){
          case 'ArrowDown': e.preventDefault(); selectedDropdownIndex = Math.min(selectedDropdownIndex+1, items.length-1); updateDropdownHighlight(items); break;
          case 'ArrowUp': e.preventDefault(); selectedDropdownIndex = Math.max(selectedDropdownIndex-1, -1); updateDropdownHighlight(items); break;
          case 'Enter':
            e.preventDefault();
            if (selectedDropdownIndex>=0 && items[selectedDropdownIndex]){
              const foodName = items[selectedDropdownIndex].dataset.foodName;
              window.selectFoodItem(foodName);
            }
            break;
          case 'Escape': hideFoodDropdown(); break;
        }
      });

      document.addEventListener('click', (e)=>{
        if (!dropdownContainer.contains(e.target) && e.target !== foodInput) hideFoodDropdown();
      });
    }

    function performFoodSearch(searchTerm){
      const matches = Array.from(savedFoodItems.values())
        .filter(f => f.name.toLowerCase().includes(searchTerm.toLowerCase()))
        .sort((a,b)=>{
          const an = a.name.toLowerCase(), bn = b.name.toLowerCase(), s = searchTerm.toLowerCase();
          if (an===s && bn!==s) return -1;
          if (bn===s && an!==s) return 1;
          if (an.startsWith(s) && !bn.startsWith(s)) return -1;
          if (bn.startsWith(s) && !an.startsWith(s)) return 1;
          return an.localeCompare(bn);
        })
        .slice(0, CONFIG.MAX_DROPDOWN_ITEMS);
      if (matches.length>0) showFoodDropdown(matches); else hideFoodDropdown();
    }
    function showFoodDropdown(matches){
      const dropdownContainer = document.getElementById('food-dropdown');
      selectedDropdownIndex = -1;
      dropdownContainer.innerHTML = matches.map((f, idx)=>`
        <div class="food-dropdown-item" data-food-name="${f.name}" onclick="selectFoodItem('${f.name.replace(/'/g,"\\'")}')" data-index="${idx}">
          <div class="font-medium">${f.name}</div>
          <div class="text-xs text-gray-500">Cal: ${f.calories||0} | P: ${f.protein||0} / C: ${f.carbs||0} / F: ${f.fat||0}</div>
        </div>`).join('');
      dropdownContainer.classList.remove('hidden');
      foodDropdownVisible = true;
    }
    function updateDropdownHighlight(items){
      items.forEach((it, idx)=>{
        it.classList.toggle('highlighted', idx===selectedDropdownIndex);
        if (idx===selectedDropdownIndex) it.scrollIntoView({block:'nearest'});
      });
    }
    function hideFoodDropdown(){
      const dropdownContainer = document.getElementById('food-dropdown');
      if (!dropdownContainer) return;
      dropdownContainer.classList.add('hidden');
      foodDropdownVisible = false;
      selectedDropdownIndex = -1;
    }

    window.selectFoodItem = (foodName)=>{
      const foodData = Array.from(savedFoodItems.values()).find(f => f.name === foodName);
      if (foodData){
        document.getElementById('food-item-input').value = foodName;
        populateStagingFromFood(foodData);
        hideFoodDropdown();
      }
    };
    function populateStagingFromFood(foodData){
      allNutrients.forEach(n => {
        const input = document.getElementById(`actual-${n}`);
        if (input && foodData[n] !== undefined) input.value = foodData[n];
      });
    }

    async function processSaveFoodItem(foodName, stagedValues){
      if (!userId) return showMessage('Cannot save food item. Not authenticated.', true);
      try {
        const foodId = foodName.toLowerCase().replace(/[^a-z0-9]/g,'_');
        const foodData = { name: foodName, ...stagedValues, lastUpdated: new Date().toISOString() };
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/foodItems`, foodId), foodData);
        savedFoodItems.set(foodId, foodData);
        showMessage(`Food item "${foodName}" saved to your database.`);
        document.getElementById('food-item-input').value = '';
        clearStagingArea();
      } catch (e){ handleError('save-food-item', e, 'Failed to save food item'); }
    }

    async function saveFoodItemToDatabase(){
      const foodNameInput = document.getElementById('food-item-input');
      let foodName = foodNameInput.value.trim();
      const stagedValues = getStagedValues();

      if (!foodName){
        // Blank name modal flow
        blankFoodNameModal.classList.remove('hidden');
        document.getElementById('blank-food-name-input').value = '';
        document.getElementById('blank-food-name-prompt').classList.remove('hidden');
        document.getElementById('blank-food-name-input-container').classList.add('hidden');

        document.getElementById('confirm-blank-name-btn').onclick = async ()=>{
          blankFoodNameModal.classList.add('hidden');
          foodName = '(blank)';
          await processSaveFoodItem(foodName, stagedValues);
        };
        document.getElementById('enter-name-btn').onclick = ()=>{
          document.getElementById('blank-food-name-prompt').classList.add('hidden');
          document.getElementById('blank-food-name-input-container').classList.remove('hidden');
          document.getElementById('blank-food-name-input').focus();
        };
        document.getElementById('submit-new-food-name-btn').onclick = async ()=>{
          const newName = document.getElementById('blank-food-name-input').value.trim();
          if (newName){
            blankFoodNameModal.classList.add('hidden');
            await processSaveFoodItem(newName, stagedValues);
          } else {
            showMessage('Please enter a name or choose to save as (blank).', true);
          }
        };
        document.getElementById('cancel-blank-name-btn').onclick = ()=>{
          blankFoodNameModal.classList.add('hidden');
          foodNameInput.value = '';
          document.getElementById('blank-food-name-prompt').classList.remove('hidden');
          document.getElementById('blank-food-name-input-container').classList.add('hidden');
        };
        return;
      }

      const existingFood = Array.from(savedFoodItems.values()).find(f => f.name.toLowerCase() === foodName.toLowerCase());
      if (existingFood){
        const hasDifferences = allNutrients.some(n => parseFloat(existingFood[n] || 0) !== parseFloat(stagedValues[n] || 0));
        if (hasDifferences){ showDuplicateDialog(existingFood, stagedValues, foodName); return; }
        showMessage(`Food item "${foodName}" already exists with identical values. No update needed.`);
        foodNameInput.value = ''; clearStagingArea(); return;
      }
      await processSaveFoodItem(foodName, stagedValues);
    }

    function showDuplicateDialog(existingFood, newValues, foodName){
      const modal = document.getElementById('duplicate-food-modal');
      const container = document.getElementById('duplicate-comparison');
      const diffs = [];
      allNutrients.forEach(n=>{
        const e = parseFloat(existingFood[n] || 0);
        const nv = parseFloat(newValues[n] || 0);
        if (e !== nv) diffs.push({ nutrient: formatNutrientName(n), existing: e, new: nv, delta: nv - e });
      });
      container.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">Food item "${foodName}" already exists with different values:</h3>
        <div class="overflow-x-auto mb-6">
          <table class="min-w-full bg-white border border-gray-300">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 border-b text-left">Nutrient</th>
                <th class="px-4 py-2 border-b text-center">Saved</th>
                <th class="px-4 py-2 border-b text-center">Current</th>
                <th class="px-4 py-2 border-b text-center">Delta</th>
              </tr>
            </thead>
            <tbody>
              ${diffs.map(d=>`
                <tr>
                  <td class="px-4 py-2 border-b font-medium">${d.nutrient}</td>
                  <td class="px-4 py-2 border-b text-center">${d.existing.toFixed(1)}</td>
                  <td class="px-4 py-2 border-b text-center">${d.new.toFixed(1)}</td>
                  <td class="px-4 py-2 border-b text-center ${d.delta>=0?'text-green-600':'text-red-600'}">${d.delta>=0?'+':''}${d.delta.toFixed(1)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
        <div class="flex gap-3 justify-center">
          <button onclick="useSavedFood('${foodName}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Use Saved Version</button>
          <button onclick="replaceSavedFood('${foodName}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Replace Saved</button>
          <button onclick="keepBothFoods()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Keep Both</button>
          <button onclick="closeDuplicateDialog()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
        </div>`;
      modal.classList.remove('hidden');
    }
    window.useSavedFood = (foodName)=>{ window.selectFoodItem(foodName); closeDuplicateDialog(); };
    window.replaceSavedFood = async (foodName)=>{
      const stagedValues = getStagedValues();
      try { await processSaveFoodItem(foodName, stagedValues); showMessage(`Food item "${foodName}" updated in database.`); }
      catch (e){ handleError('replace-saved-food', e, 'Failed to update food item.'); }
      closeDuplicateDialog();
    };
    window.keepBothFoods = ()=>{
      const currentName = document.getElementById('food-item-input').value.trim();
      showConfirmationModal(`Enter a new name for the current version (currently "${currentName}"):`,
        (newName)=>{
          if (newName && newName.trim() && newName.trim() !== currentName){
            document.getElementById('food-item-input').value = newName.trim();
            closeDuplicateDialog();
            saveFoodItemToDatabase();
          } else { showMessage('Please enter a different name.', true); }
        },
        ()=>{}, true, currentName
      );
    };
    window.closeDuplicateDialog = ()=> document.getElementById('duplicate-food-modal').classList.add('hidden');
    window.closeBlankFoodNameModal = ()=>{
      document.getElementById('blank-food-name-modal').classList.add('hidden');
      document.getElementById('blank-food-name-input').value = '';
      document.getElementById('blank-food-name-prompt').classList.remove('hidden');
      document.getElementById('blank-food-name-input-container').classList.add('hidden');
    };

    // Remove a logged item (subtracts nutrients and saves)
    window.removeFoodItem = async (index)=>{
      if (index<0 || index>=dailyFoodItems.length) return;
      const itemToRemove = dailyFoodItems[index];
      showConfirmationModal(`Remove "${itemToRemove.name || '(blank)'}"?\n\nThis will subtract its nutrients from today's totals.`, async ()=>{
        try{
          const dateStr = dateInput.value;
          const todayEntry = dailyEntries.get(dateStr) || { date: dateStr, foodItems: [] };
          allNutrients.forEach(n=>{
            const cur = parseFloat(todayEntry[n]) || 0;
            const val = parseFloat(itemToRemove[n]) || 0;
            todayEntry[n] = Math.max(0, cur - val);
          });
          dailyFoodItems.splice(index,1);
          todayEntry.foodItems = dailyFoodItems;
          await saveDailyEntry(dateStr, todayEntry);
          showMessage(`Removed "${itemToRemove.name || '(blank)'}" and updated totals.`);
        } catch (e){ handleError('remove-food-item', e, 'Failed to remove food item.'); }
      });
    };

    function openFoodManager(){
      const modal = document.getElementById('food-manager-modal');
      const container = document.getElementById('food-manager-list');
      const list = Array.from(savedFoodItems.entries()).sort(([,a],[,b])=> a.name.localeCompare(b.name));
      container.innerHTML = list.map(([id, f])=>`
        <div class="flex justify-between items-center p-3 border-b border-gray-200">
          <div>
            <div class="font-medium">${f.name}</div>
            <div class="text-sm text-gray-500">Cal: ${f.calories||0} | P: ${f.protein||0} / C: ${f.carbs||0} / F: ${f.fat||0}</div>
          </div>
          <div class="flex gap-2">
            <button onclick="editFoodItem('${id}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Edit</button>
            <button onclick="deleteFoodItemFromManager('${id}')" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">Delete</button>
          </div>
        </div>`).join('') || '<p class="text-gray-500 text-center p-4">No saved food items.</p>';
      modal.classList.remove('hidden');
    }
    window.editFoodItem = (foodId)=>{
      const food = savedFoodItems.get(foodId);
      if (food){
        document.getElementById('food-item-input').value = food.name;
        populateStagingFromFood(food);
        document.getElementById('food-manager-modal').classList.add('hidden');
        showMessage(`Loaded "${food.name}" for editing. Modify values and save to update.`);
      }
    };
    window.deleteFoodItemFromManager = async (foodId)=>{
      const food = savedFoodItems.get(foodId);
      if (!food) return;
      showConfirmationModal(`Delete "${food.name}" from saved foods?\n\nThis will also subtract its nutrients from today's totals if it was consumed today.`, async ()=>{
        try{
          const dateStr = dateInput.value;
          const todayEntry = dailyEntries.get(dateStr) || { date: dateStr };
          let removedCount = 0;

          dailyFoodItems = dailyFoodItems.filter(item=>{
            if (item.name === food.name){
              allNutrients.forEach(n=>{
                const cur = parseFloat(todayEntry[n]) || 0;
                const val = parseFloat(item[n]) || 0;
                todayEntry[n] = Math.max(0, cur - val);
              });
              removedCount++; return false;
            }
            return true;
          });

          if (removedCount>0) await saveDailyEntry(dateStr, todayEntry);
          await deleteFoodItem(foodId);
          showMessage(`Deleted "${food.name}" from saved foods${removedCount>0 ? ` and subtracted ${removedCount} servings from today's totals` : ''}.`);
          openFoodManager();
          updateFoodItemsList();
        } catch (e){ handleError('delete-food-manager', e, 'Failed to delete food item.'); }
      });
    };
    window.closeFoodManager = ()=> document.getElementById('food-manager-modal').classList.add('hidden');

    // ==========================
    // ===== CALCULATIONS =======
    // ==========================
    function calculateDashboardMetrics(){
      const todayStr = dateInput.value;
      const today = new Date(`${todayStr}T00:00:00`);
      const yesterday = getPastDate(today, 1);
      const todayEntry = dailyEntries.get(formatDate(today)) || {};
      const yesterdayEntry = dailyEntries.get(formatDate(yesterday)) || {};
      const T = (name)=> parseFloat(baselineTargets[name] || 0);

      const calcAdjusted = (n)=>{
        const baselineTarget = T(n);
        const yActual = parseFloat(yesterdayEntry[n]) || baselineTarget;
        const variance = baselineTarget - yActual;
        return Math.max(0, baselineTarget + variance);
      };

      const metrics = {};
      allNutrients.forEach(n=>{
        const base = T(n);
        const adjustedTarget =
          (dailyTrackedNutrients.includes(n) || n === 'calories' || n === 'protein')
            ? base : calcAdjusted(n);
        metrics[n] = { name:n, baselineTarget: base, adjustedTarget, actualToday: parseFloat(todayEntry[n]) || 0 };
      });

      const adjustedCalorieTarget = metrics['calories'].adjustedTarget;
      const proteinGrams = metrics['protein'].adjustedTarget;
      const proteinCalories = proteinGrams * 4;
      let adjustedFatGrams = metrics['fat'].adjustedTarget;
      const fatMin = getFatMinimum();
      if (adjustedFatGrams < fatMin) adjustedFatGrams = fatMin;
      const fatCalories = adjustedFatGrams * 9;
      const carbCalories = adjustedCalorieTarget - proteinCalories - fatCalories;
      const adjustedCarbGrams = Math.max(0, carbCalories / 4);

      metrics['fat'].adjustedTarget = adjustedFatGrams;
      metrics['carbs'].adjustedTarget = adjustedCarbGrams;

      for (const n in metrics){
        const m = metrics[n];
        m.percentage = m.adjustedTarget > 0 ? (m.actualToday / m.adjustedTarget) * 100 : 0;
        m.diff = m.actualToday - m.adjustedTarget;
      }
      return { metrics };
    }

    // ==========================
    // ===== DASHBOARD UI =======
    // ==========================
    function updateDashboard(){
      if (!userId || Object.keys(baselineTargets).length === 0){
        dashboard.innerHTML = `
          <div class="text-center p-8 bg-white rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700">Welcome!</h3>
            <p class="mt-2 text-gray-500">Please log in and set your baseline targets to get started.</p>
            <button onclick="document.getElementById('open-settings-btn').click()"
              class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Set Targets</button>
          </div>`;
        return;
      }

      const { metrics } = calculateDashboardMetrics();

      const card = (m)=>{
        const pct = m.percentage;
        let color = 'bg-red-500';
        if (pct >= 90 && pct <= 110) color = 'bg-green-500';
        else if (pct >= 75 || pct > 110) color = 'bg-yellow-500';
        const diffText = m.diff > 0 ? `+${m.diff.toFixed(1)}` : m.diff.toFixed(1);
        const diffColor = m.diff >= 0 ? 'text-green-600' : 'text-red-600';
        return `
          <div class="bg-white p-4 rounded-lg shadow-md nutrient-card">
            <h4 class="font-bold capitalize text-gray-800">${formatNutrientName(m.name)}</h4>
            <p class="text-sm text-gray-500">${m.actualToday.toFixed(1)} / ${m.adjustedTarget.toFixed(1)}</p>
            <div class="w-full progress-bar-bg rounded-full h-2.5 mt-2">
              <div class="progress-bar-fill h-2.5 rounded-full ${color}" style="width:${Math.min(100, pct)}%"></div>
            </div>
            <p class="text-sm font-medium text-gray-600 mt-2">Status: <span class="font-bold ${diffColor}">${diffText}</span></p>
          </div>`;
      };

      const group = (title, keys)=>`
        <div class="mb-8">
          <h3 class="text-2xl font-bold text-gray-700 mb-4">${title}</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${keys.map(k => metrics[k] ? card(metrics[k]) : '').join('')}
          </div>
        </div>`;

      const infoBox = `
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h3 class="font-semibold text-blue-900 mb-2"><i class="fas fa-info-circle mr-2"></i>How This Works</h3>
          <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
            <li><strong>Daily Nutrients:</strong> Targets for these nutrients (like Protein) are fixed each day.</li>
            <li><strong>Averaged Nutrients:</strong> Today's targets adjust based on yesterday's intake to get you back to baseline tomorrow.</li>
            <li><strong>Carbs:</strong> The carb target is dynamic, filling the remainder of your adjusted calorie budget.</li>
          </ul>
        </div>`;

      const chartSection = `
        <div class="mb-8 bg-white p-6 rounded-lg shadow-lg">
          <h3 class="text-2xl font-bold text-gray-700 mb-4">Nutrition Progress Chart</h3>
          <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="chart-nutrients" class="block text-sm font-medium text-gray-700 mb-1">Select Nutrients (hold Ctrl/Cmd for multiple)</label>
              <select id="chart-nutrients" multiple class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" size="4"></select>
            </div>
            <div>
              <label for="chart-timeframe" class="block text-sm font-medium text-gray-700 mb-1">Time Frame</label>
              <select id="chart-timeframe" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="3days">Last 3 Days</option>
                <option value="week">Last Week</option>
                <option value="month">Last Month</option>
                <option value="year">Last Year</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Options</label>
              <div class="flex items-center mt-2">
                <input type="checkbox" id="show-3day-avg" class="mr-2">
                <label for="show-3day-avg" class="text-sm text-gray-700">Show 3-day average</label>
              </div>
            </div>
          </div>
          <div class="chart-container"><canvas id="nutrition-chart"></canvas></div>
          <div id="chart-table" class="mt-6"></div>
        </div>`;

      dashboard.innerHTML =
        infoBox + chartSection +
        group('Macronutrients', nutrients.macros) +
        group('Daily Vitamins (Fixed Target)', nutrients.vitaminsDaily) +
        group('Daily Minerals (Fixed Target)', nutrients.mineralsDaily) +
        group('Averaged Vitamins (Adjusted Target)', nutrients.vitaminsAvg) +
        group('Averaged Minerals (Adjusted Target)', nutrients.mineralsAvg) +
        group('Optional Nutrients (Adjusted Target)', nutrients.optional);

      initializeChartControls();
    }

    function populateSettingsForm(){
      allNutrients.forEach(n => {
        const input = document.getElementById(`target-${n}`);
        if (input) input.value = baselineTargets[n] || '';
      });
      const fatMinInput = document.getElementById('target-fatMinimum');
      if (fatMinInput) fatMinInput.value = baselineTargets.fatMinimum || CONFIG.DEFAULT_FAT_MINIMUM;
    }

    // ==========================
    // ===== STAGING PARSE ======
    // ==========================
    const nutrientMap = {
      'calories':'calories','cal':'calories','protein':'protein','prot':'protein',
      'carbs':'carbs','carbohydrate':'carbs','fat':'fat','vitamin d':'vitaminD','vit d':'vitaminD',
      'vitamin b12':'vitaminB12','vit b12':'vitaminB12','b12':'vitaminB12','folate':'folate','b9':'folate',
      'vitamin c':'vitaminC','vit c':'vitaminC','vitamin b6':'vitaminB6','vit b6':'vitaminB6','b6':'vitaminB6',
      'vitamin a':'vitaminA','vit a':'vitaminA','vitamin e':'vitaminE','vit e':'vitaminE',
      'vitamin k':'vitaminK','vit k':'vitaminK','iron':'iron','calcium':'calcium','magnesium':'magnesium','zinc':'zinc',
      'potassium':'potassium','sodium':'sodium','selenium':'selenium','iodine':'iodine','phosphorus':'phosphorus',
      'omega-3':'omega3','omega 3':'omega3','fiber':'fiber','choline':'choline'
    };

    function parseAndStage(){
      const text = document.getElementById('paste-area').value;
      if (!text) return showMessage('Paste area is empty.', true);
      const lines = text.split('\n');
      let valuesFound = 0;
      lines.forEach(line=>{
        const lower = line.toLowerCase();
        for (const key in nutrientMap){
          const re = new RegExp(`\\b${key}\\b`,'i');
          if (re.test(lower)){
            let numberString = lower.replace(re,'').replace(/(mg|mcg|g|kcal)/gi,'').replace(/,/g,'');
            const match = numberString.match(/-?[\d.]+/);
            if (match){
              const n = nutrientMap[key];
              const el = document.getElementById(`actual-${n}`);
              if (el){ el.value = parseFloat(match[0]); valuesFound++; }
              break;
            }
          }
        }
      });
      if (valuesFound>0) showMessage(`Parsed and staged ${valuesFound} fields.`);
      else showMessage('Could not find any recognizable nutrient values.', true);
    }

    function getStagedValues(){
      const vals = {};
      allNutrients.forEach(n=>{
        const input = document.getElementById(`actual-${n}`);
        if (input) vals[n] = parseFloat(input.value) || 0;
      });
      return vals;
    }

    async function addStagedNutrientsToDailyLog(){
      const staged = getStagedValues();
      const dateStr = dateInput.value;
      const newEntry = dailyEntries.get(dateStr) || { date: dateStr, foodItems: [] };
      allNutrients.forEach(n=> newEntry[n] = (parseFloat(newEntry[n])||0) + (staged[n]||0));
    
      // Get the food name from the input field, or use "(blank)" if empty
      const foodNameInput = document.getElementById('food-item-input');
      const foodName = foodNameInput?.value.trim() || '(blank)';
      
      const foodItem = { name: foodName, calories: staged.calories||0, protein: staged.protein||0, carbs: staged.carbs||0, fat: staged.fat||0, timestamp:new Date().toISOString(), ...staged };
      dailyFoodItems.push(foodItem);
      await saveDailyEntry(dateStr, newEntry);
      showMessage("Staged nutrients added to today's log!");
      clearStagingArea();
    }

    async function subtractStagedNutrientsFromDailyLog(){
      const staged = getStagedValues();
      const dateStr = dateInput.value;
      const newEntry = dailyEntries.get(dateStr) || { date: dateStr, foodItems: [] };
      allNutrients.forEach(n=> newEntry[n] = Math.max(0, (parseFloat(newEntry[n])||0) - (staged[n]||0)));

      const neg = Object.fromEntries(Object.entries(staged).map(([k,v])=>[k,-(v||0)]));
      const foodNameInput = document.getElementById('food-item-input');
      const foodName = foodNameInput?.value.trim() || '(blank)';
      const foodItem = { name: `${foodName} (subtracted)`, calories: -(staged.calories||0), protein: -(staged.protein||0), carbs: -(staged.carbs||0), fat: -(staged.fat||0), timestamp:new Date().toISOString(), ...neg };      dailyFoodItems.push(foodItem);

      await saveDailyEntry(dateStr, newEntry);
      showMessage("Staged nutrients subtracted from today's log!");
      clearStagingArea();
    }

    function handleStagingAction(mode){
      const staged = getStagedValues();
      const dateStr = dateInput.value;
      if (mode==='updateTargets'){
        showConfirmationModal('Update your baseline targets with staged values?', ()=> saveTargets(staged));
        return;
      }
      if (mode==='replace'){
        showConfirmationModal(`Replace all of ${dateStr} with staged values? This will overwrite existing data for this day.`, async ()=>{
          const newEntry = { date: dateStr, foodItems: [] };
          allNutrients.forEach(n=> newEntry[n] = staged[n] || 0);
          const foodNameInput = document.getElementById('food-item-input');
          const foodName = foodNameInput?.value.trim() || '(blank)';
          dailyFoodItems = [{ name: foodName, calories: staged.calories||0, protein: staged.protein||0, carbs: staged.carbs||0, fat: staged.fat||0, timestamp:new Date().toISOString(), ...staged }];          await saveDailyEntry(dateStr, newEntry);
          showMessage("Day's log replaced with staged values!");
          clearStagingArea();
        });
      }
    }

    // ==========================
    // ===== CHARTING ===========
    // ==========================
    function initializeChartControls(){
      const chartNutrients = document.getElementById('chart-nutrients');
      const chartTimeframe = document.getElementById('chart-timeframe');
      const show3DayAvg = document.getElementById('show-3day-avg');
      if (!chartNutrients) return;

      chartNutrients.innerHTML = '';
      allNutrients.forEach(n=>{
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = formatNutrientName(n);
        if (n===CONFIG.DEFAULT_CHART_NUTRIENT) opt.selected = true;
        chartNutrients.appendChild(opt);
      });
      chartTimeframe.value = CONFIG.DEFAULT_CHART_TIMEFRAME;

      chartNutrients.addEventListener('change', updateChart);
      chartTimeframe.addEventListener('change', updateChart);
      show3DayAvg.addEventListener('change', updateChart);

      updateChart();
    }

    function getChartData(nutrientKeys, timeframe, showAvg=false){
      const endDate = new Date(`${dateInput.value}T00:00:00`);
      let days = 7;
      if (timeframe==='3days') days = 3;
      else if (timeframe==='week') days = 7;
      else if (timeframe==='month') days = 30;
      else if (timeframe==='year') days = 365;

      const extendedDays = days + CONFIG.CHART_AVERAGE_LOOKBACK;
      const extendedStart = getPastDate(endDate, extendedDays - 1);
      const displayStart = getPastDate(endDate, days - 1);

      const allLabels = [];
      const displayLabels = [];
      const datasets = [];
      const tableData = {};

      for (let i=0;i<extendedDays;i++){
        const d = new Date(extendedStart); d.setDate(extendedStart.getDate()+i);
        allLabels.push(formatDate(d));
      }
      for (let i=0;i<days;i++){
        const d = new Date(displayStart); d.setDate(displayStart.getDate()+i);
        const ds = formatDate(d);
        displayLabels.push(ds); tableData[ds] = {};
      }

      nutrientKeys.forEach((n, idx)=>{
        const displayData = displayLabels.map(ds=>{
          const entry = dailyEntries.get(ds) || {};
          const actual = parseFloat(entry[n]) || 0;
          const baseline = parseFloat(baselineTargets[n]) || 1;
          return baseline>0 ? (actual / baseline) * 100 : 0;
        });
        const actualVals = displayLabels.map(ds=>{
          const entry = dailyEntries.get(ds) || {};
          return parseFloat(entry[n]) || 0;
        });

        datasets.push({
          label: formatNutrientName(n),
          data: displayData,
          backgroundColor: CONFIG.CHART_COLORS[idx % CONFIG.CHART_COLORS.length],
          borderColor: CONFIG.CHART_COLORS[idx % CONFIG.CHART_COLORS.length],
          borderWidth: 1,
          actualValues: actualVals
        });

        displayLabels.forEach((ds, i)=>{
          tableData[ds][n] = { actual: actualVals[i], percentage: displayData[i], baseline: parseFloat(baselineTargets[n]) || 0 };
        });

        if (showAvg && !dailyTrackedNutrients.includes(n)){
          const avgData = displayLabels.map((ds)=>{
            const idxAll = allLabels.indexOf(ds);
            if (idxAll < 2) return null;
            let sum = 0, count = 0;
            for (let j=0;j<3;j++){
              const lookbackDate = allLabels[idxAll - j];
              const entry = dailyEntries.get(lookbackDate) || {};
              const actual = parseFloat(entry[n]) || 0;
              sum += actual; count++;
            }
            const avg = count ? sum / count : 0;
            const baseline = parseFloat(baselineTargets[n]) || 1;
            return baseline>0 ? (avg / baseline) * 100 : 0;
          });
          datasets.push({
            label: `${formatNutrientName(n)} (3-day avg)`,
            data: avgData,
            type: 'line',
            borderColor: CONFIG.CHART_COLORS[idx % CONFIG.CHART_COLORS.length],
            backgroundColor: 'transparent',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            spanGaps: false,
            tension: 0.4,
            cubicInterpolationMode: 'monotone',
            order: 0
          });
        }
      });

      return { labels: displayLabels, datasets, tableData };
    }

    function updateChart(){
      if (!userId || Object.keys(baselineTargets).length===0) return;
      const chartNutrients = document.getElementById('chart-nutrients');
      const chartTimeframe = document.getElementById('chart-timeframe');
      const show3DayAvg = document.getElementById('show-3day-avg');
      if (!chartNutrients) return;

      const selected = Array.from(chartNutrients.selectedOptions).map(o=>o.value);
      const timeframe = chartTimeframe.value;
      const showAvg = show3DayAvg.checked;
      if (selected.length===0) return;

      const { labels, datasets, tableData } = getChartData(selected, timeframe, showAvg);
      const canvas = document.getElementById('nutrition-chart'); if (!canvas) return;
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(canvas.getContext('2d'), {
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:'Target (100%)', data:new Array(labels.length).fill(100), type:'line', borderColor:'#6B7280', borderDash:[5,5], borderWidth:2, fill:false, pointRadius:0, order:1 },
            ...datasets
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            y:{ beginAtZero:true, title:{ display:true, text:'% of Baseline Target' } },
            x:{ title:{ display:true, text:'Date' } }
          },
          plugins:{
            tooltip:{
              callbacks:{
                label: (ctx)=>{
                  if (ctx.datasetIndex===0) return 'Target: 100%';
                  const dsIdx = ctx.datasetIndex - 1;
                  if (datasets[dsIdx] && datasets[dsIdx].actualValues){
                    const actual = datasets[dsIdx].actualValues[ctx.dataIndex];
                    const pct = ctx.parsed.y;
                    return `${ctx.dataset.label}: ${actual.toFixed(1)} (${pct.toFixed(1)}%)`;
                  }
                  return `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`;
                }
              }
            },
            legend:{ display:true }
          }
        }
      });

      updateChartTable(tableData, selected, labels);
    }

    function updateChartTable(tableData, nutrientKeys, labels){
      const tableContainer = document.getElementById('chart-table');
      if (!Object.keys(tableData).length || !nutrientKeys.length){
        tableContainer.innerHTML = '<p class="text-gray-500 text-center">No data available</p>'; return;
      }
      let html = `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-gray-300 rounded-lg">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 border-b text-left font-semibold text-gray-700">Nutrient</th>`;
      labels.forEach(d => html += `<th class="px-2 py-2 border-b text-center font-semibold text-gray-700 text-xs">${d}</th>`);
      html += `</tr></thead><tbody>`;

      nutrientKeys.forEach(n=>{
        html += `<tr class="hover:bg-gray-50"><td class="px-4 py-2 border-b font-medium">${formatNutrientName(n)}</td>`;
        labels.forEach(d=>{
          const data = tableData[d][n];
          if (data){
            const color = (data.percentage>=90 && data.percentage<=110) ? 'text-green-600' : (data.percentage>=75 ? 'text-yellow-600' : 'text-red-600');
            html += `<td class="px-2 py-2 border-b text-center text-xs"><div>${data.actual.toFixed(1)}</div><div class="${color}">${data.percentage.toFixed(0)}%</div></td>`;
          } else html += `<td class="px-2 py-2 border-b text-center text-xs">-</td>`;
        });
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      tableContainer.innerHTML = html;
    }

    // ==========================
    // ===== EXPORTS ============
    // ==========================
    async function exportTargetsJson(){
      if (!userId) return showMessage('Cannot export targets. Not authenticated.', true);
      try {
        const targets = await fetchTargets();
        const blob = new Blob([JSON.stringify(targets, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `nutrition_targets_${formatDate(new Date())}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showMessage('Targets exported successfully as JSON!');
      } catch (e){ handleError('export-targets', e, 'Failed to export targets.'); }
    }

    async function exportSavedFoodsCsv(){
      if (!userId) return showMessage('Cannot export saved foods. Not authenticated.', true);
      try {
        const foods = Array.from(savedFoodItems.values());
        if (!foods.length) return showMessage('No saved food items to export.', true);
        const headers = ['name','lastUpdated',...allNutrients];
        let csv = headers.map(h=>`"${h}"`).join(',') + '\n';
        foods.forEach(f=>{
          const row = headers.map(h=>{
            let v = f[h] ?? '';
            if (typeof v === 'string') v = `"${v.replace(/"/g,'""')}"`;
            return v;
          }).join(',');
          csv += row + '\n';
        });
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `saved_food_items_${formatDate(new Date())}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showMessage('Saved food items exported successfully as CSV!');
      } catch (e){ handleError('export-saved-foods', e, 'Failed to export saved food items.'); }
    }

    // ==========================
    // ===== EVENT WIRING =======
    // ==========================
    document.addEventListener('DOMContentLoaded', ()=>{
      cacheDom();
      ensureDateInput();
      loader.classList.remove('hidden');
      setTimeout(setupFoodDropdown, 100);

      document.getElementById('open-login-btn').addEventListener('click', ()=> loginModal.classList.remove('hidden'));
      document.getElementById('close-login-btn').addEventListener('click', ()=> loginModal.classList.add('hidden'));
      document.getElementById('login-btn').addEventListener('click', handleLogin);
      document.getElementById('signup-btn').addEventListener('click', handleSignUp);
      document.getElementById('guest-btn').addEventListener('click', handleGuestLogin);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('open-settings-btn').addEventListener('click', ()=> settingsModal.classList.remove('hidden'));
      document.getElementById('close-settings-btn').addEventListener('click', ()=> settingsModal.classList.add('hidden'));

      document.getElementById('settings-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const newTargets = {};
        allNutrients.forEach(n=> newTargets[n] = parseFloat(document.getElementById(`target-${n}`).value) || 0);
        newTargets.fatMinimum = parseFloat(document.getElementById('target-fatMinimum').value) || CONFIG.DEFAULT_FAT_MINIMUM;
        saveTargets(newTargets);
        settingsModal.classList.add('hidden');
      });

      dateInput.addEventListener('change', async ()=>{ await loadUserData(); });

      document.getElementById('parse-btn').addEventListener('click', parseAndStage);
      document.getElementById('add-day-btn').addEventListener('click', addStagedNutrientsToDailyLog);
      document.getElementById('subtract-day-btn').addEventListener('click', subtractStagedNutrientsFromDailyLog);
      document.getElementById('replace-day-btn').addEventListener('click', ()=> handleStagingAction('replace'));
      document.getElementById('stage-to-targets-btn').addEventListener('click', ()=> handleStagingAction('updateTargets'));

      document.getElementById('save-food-item-btn').addEventListener('click', saveFoodItemToDatabase);
      document.getElementById('food-item-input').addEventListener('keypress', (e)=>{ if (e.key==='Enter') saveFoodItemToDatabase(); });

      document.getElementById('open-food-manager-btn').addEventListener('click', openFoodManager);

      document.getElementById('export-all-data-btn').addEventListener('click', async ()=>{
        showMessage('Fetching all daily log data for export...', false);
        const entries = await fetchAllEntries();
        if (!entries.length) return showMessage('No daily log data to export.', true);
        const headers = ['date', ...allNutrients, 'foodItems'];
        let csv = "data:text/csv;charset=utf-8," + headers.map(h=>`"${h}"`).join(",") + "\n";
        entries.forEach(e=>{
          const row = headers.map(h=>{
            if (h==='foodItems') return `"${JSON.stringify(e.foodItems||[]).replace(/"/g,'""')}"`;
            let v = e[h] ?? '0';
            if (typeof v === 'string') v = `"${v.replace(/"/g,'""')}"`;
            return v;
          });
          csv += row.join(",") + "\n";
        });
        const uri = encodeURI(csv);
        const a = document.createElement('a'); a.href = uri; a.download = 'nutrition_daily_log_export.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        showMessage('Daily log export complete!', false);
      });

      document.getElementById('export-targets-json-btn').addEventListener('click', exportTargetsJson);
      document.getElementById('export-saved-foods-csv-btn').addEventListener('click', exportSavedFoodsCsv);

      window.openSettings = ()=> settingsModal.classList.remove('hidden');
    });
  </script>

  <!-- Main Application Body -->
  <div id="loader" class="flex justify-center items-center h-screen">
    <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
  </div>

  <div id="main-content" class="hidden">
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fas fa-chart-pie text-3xl text-blue-600 mr-3"></i>
        <h1 class="text-2xl font-bold text-gray-800">3-Day Rolling Nutrition Tracker</h1>
      </div>
      <div class="flex items-center space-x-4">
        <span id="user-status" class="text-gray-600 text-sm hidden"></span>
        <button id="open-login-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Login / Sign Up</button>
        <button id="logout-btn" class="hidden px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Logout</button>
        <button id="open-settings-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300"><i class="fas fa-cog"></i></button>
      </div>
    </header>

    <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Daily Log</h2>

        <div class="mb-4">
          <label for="date-input" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
          <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="mb-4">
          <label for="paste-area" class="block text-sm font-medium text-gray-700 mb-1">Paste Log to Stage</label>
          <textarea id="paste-area" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Paste your log here..."></textarea>
          <button type="button" id="parse-btn" class="w-full mt-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">
            <i class="fas fa-arrow-down mr-2"></i>Parse to Staging Area
          </button>
        </div>

        <hr class="my-4">
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Staging Area</h3>

        <div class="flex justify-between items-center mb-4">
          <div class="flex gap-2">
            <button type="button" id="add-day-btn" class="w-10 h-10 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 flex items-center justify-center" title="Add staged nutrients to today's log"><i class="fas fa-plus"></i></button>
            <button type="button" id="subtract-day-btn" class="w-10 h-10 bg-yellow-500 text-white font-bold rounded-lg shadow-md hover:bg-yellow-600 flex items-center justify-center" title="Subtract staged nutrients from today's log"><i class="fas fa-minus"></i></button>
          </div>
          <div class="flex gap-2">
            <button type="button" id="replace-day-btn" class="px-3 py-1 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 text-xs" title="Replace today's entire log with staged values">Replace Day</button>
            <button type="button" id="stage-to-targets-btn" class="px-3 py-1 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 text-xs" title="Update your baseline targets with staged values">Update Targets</button>
          </div>
        </div>

        <!-- Food DB -->
        <div class="mb-4 p-3 bg-green-50 rounded-lg border border-green-200">
          <div class="flex justify-between items-center mb-2">
            <label for="food-item-input" class="block text-sm font-medium text-gray-700">Food Item Database</label>
            <button type="button" id="open-food-manager-btn" class="text-xs px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">
              <i class="fas fa-list mr-1"></i>Manage Foods
            </button>
          </div>
          <div class="food-dropdown relative">
            <input type="text" id="food-item-input" placeholder="Enter or select food name..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            <div id="food-dropdown" class="food-dropdown-list hidden"></div>
          </div>
          <button type="button" id="save-food-item-btn" class="w-full mt-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Save Food Item</button>

          <div class="mt-3">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Today's Food Items:</h4>
            <div id="food-items-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
          </div>
        </div>

        <!-- Staging inputs -->
        <div class="space-y-3 max-h-[45vh] overflow-y-auto pr-2">
          <h4 class="text-lg font-semibold text-gray-700 pt-2 sticky top-0 bg-white">Macros</h4>
          <div><label for="actual-calories" class="block text-sm font-medium text-gray-600">Calories</label><input type="number" step="any" id="actual-calories" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-protein" class="block text-sm font-medium text-gray-600">Protein (g)</label><input type="number" step="any" id="actual-protein" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-carbs" class="block text-sm font-medium text-gray-600">Carbs (g)</label><input type="number" step="any" id="actual-carbs" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-fat" class="block text-sm font-medium text-gray-600">Fat (g)</label><input type="number" step="any" id="actual-fat" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <h4 class="text-lg font-semibold text-gray-700 pt-4 sticky top-0 bg-white">Daily Vitamins</h4>
          <div><label for="actual-vitaminB12" class="block text-sm font-medium text-gray-600">Vitamin B12 (mcg)</label><input type="number" step="any" id="actual-vitaminB12" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-folate" class="block text-sm font-medium text-gray-600">Folate (mcg)</label><input type="number" step="any" id="actual-folate" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-vitaminC" class="block text-sm font-medium text-gray-600">Vitamin C (mg)</label><input type="number" step="any" id="actual-vitaminC" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-vitaminB6" class="block text-sm font-medium text-gray-600">Vitamin B6 (mg)</label><input type="number" step="any" id="actual-vitaminB6" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <h4 class="text-lg font-semibold text-gray-700 pt-4 sticky top-0 bg-white">Averaged Vitamins</h4>
          <div><label for="actual-vitaminA" class="block text-sm font-medium text-gray-600">Vitamin A (mcg)</label><input type="number" step="any" id="actual-vitaminA" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-vitaminD" class="block text-sm font-medium text-gray-600">Vitamin D (mcg)</label><input type="number" step="any" id="actual-vitaminD" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-vitaminE" class="block text-sm font-medium text-gray-600">Vitamin E (mg)</label><input type="number" step="any" id="actual-vitaminE" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-vitaminK" class="block text-sm font-medium text-gray-600">Vitamin K (mcg)</label><input type="number" step="any" id="actual-vitaminK" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <h4 class="text-lg font-semibold text-gray-700 pt-4 sticky top-0 bg-white">Daily Minerals</h4>
          <div><label for="actual-iron" class="block text-sm font-medium text-gray-600">Iron (mg)</label><input type="number" step="any" id="actual-iron" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-calcium" class="block text-sm font-medium text-gray-600">Calcium (mg)</label><input type="number" step="any" id="actual-calcium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-magnesium" class="block text-sm font-medium text-gray-600">Magnesium (mg)</label><input type="number" step="any" id="actual-magnesium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-zinc" class="block text-sm font-medium text-gray-600">Zinc (mg)</label><input type="number" step="any" id="actual-zinc" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-potassium" class="block text-sm font-medium text-gray-600">Potassium (mg)</label><input type="number" step="any" id="actual-potassium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-sodium" class="block text-sm font-medium text-gray-600">Sodium (mg)</label><input type="number" step="any" id="actual-sodium" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <h4 class="text-lg font-semibold text-gray-700 pt-4 sticky top-0 bg-white">Averaged Minerals</h4>
          <div><label for="actual-selenium" class="block text-sm font-medium text-gray-600">Selenium (mcg)</label><input type="number" step="any" id="actual-selenium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-iodine" class="block text-sm font-medium text-gray-600">Iodine (mcg)</label><input type="number" step="any" id="actual-iodine" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-phosphorus" class="block text-sm font-medium text-gray-600">Phosphorus (mg)</label><input type="number" step="any" id="actual-phosphorus" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <h4 class="text-lg font-semibold text-gray-700 pt-4 sticky top-0 bg-white">Optional</h4>
          <div><label for="actual-omega3" class="block text-sm font-medium text-gray-600">Omega-3 (g)</label><input type="number" step="any" id="actual-omega3" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-fiber" class="block text-sm font-medium text-gray-600">Fiber (g)</label><input type="number" step="any" id="actual-fiber" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="actual-choline" class="block text-sm font-medium text-gray-600">Choline (mg)</label><input type="number" step="any" id="actual-choline" class="w-full p-2 border border-gray-300 rounded-md"></div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div id="dashboard"></div>
      </div>
    </main>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm relative">
      <button id="close-login-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Account Access</h2>

      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email-input" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="email-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
        </div>
        <div>
          <label for="password-input" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="password-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
        </div>
        <div class="flex space-x-2 pt-2">
          <button type="button" id="login-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-blue-700">Login</button>
          <button type="button" id="signup-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-green-700">Sign Up</button>
        </div>
      </form>

      <div class="my-4 flex items-center">
        <hr class="flex-grow border-t border-gray-300">
        <span class="mx-2 text-gray-500 text-sm">OR</span>
        <hr class="flex-grow border-t border-gray-300">
      </div>
      <button id="guest-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-gray-600">Continue as Guest</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] relative">
      <button id="close-settings-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Set Baseline Targets</h2>
      <form id="settings-form" class="overflow-y-auto max-h-[70vh] pr-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-2 border-b pb-2 mb-2">Macros</h3></div>
          <div><label for="target-calories" class="block text-sm font-medium text-gray-600">Calories</label><input type="number" step="any" id="target-calories" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-protein" class="block text-sm font-medium text-gray-600">Protein (g)</label><input type="number" step="any" id="target-protein" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-carbs" class="block text-sm font-medium text-gray-600">Carbs (g)</label><input type="number" step="any" id="target-carbs" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-fat" class="block text-sm font-medium text-gray-600">Fat (g)</label><input type="number" step="any" id="target-fat" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-4 border-b pb-2 mb-2">Configuration</h3></div>
          <div><label for="target-fatMinimum" class="block text-sm font-medium text-gray-600">Minimum Fat (g)</label><input type="number" step="any" id="target-fatMinimum" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-4 border-b pb-2 mb-2">Daily Vitamins (Water-Soluble)</h3></div>
          <div><label for="target-vitaminB12" class="block text-sm font-medium text-gray-600">Vitamin B12 (mcg)</label><input type="number" step="any" id="target-vitaminB12" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-folate" class="block text-sm font-medium text-gray-600">Folate (mcg)</label><input type="number" step="any" id="target-folate" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-vitaminC" class="block text-sm font-medium text-gray-600">Vitamin C (mg)</label><input type="number" step="any" id="target-vitaminC" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-vitaminB6" class="block text-sm font-medium text-gray-600">Vitamin B6 (mg)</label><input type="number" step="any" id="target-vitaminB6" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-4 border-b pb-2 mb-2">Averaged Vitamins (Fat-Soluble)</h3></div>
          <div><label for="target-vitaminA" class="block text-sm font-medium text-gray-600">Vitamin A (mcg)</label><input type="number" step="any" id="target-vitaminA" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-vitaminD" class="block text-sm font-medium text-gray-600">Vitamin D (mcg)</label><input type="number" step="any" id="target-vitaminD" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-vitaminE" class="block text-sm font-medium text-gray-600">Vitamin E (mg)</label><input type="number" step="any" id="target-vitaminE" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-vitaminK" class="block text-sm font-medium text-gray-600">Vitamin K (mcg)</label><input type="number" step="any" id="target-vitaminK" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-4 border-b pb-2 mb-2">Daily Minerals</h3></div>
          <div><label for="target-iron" class="block text-sm font-medium text-gray-600">Iron (mg)</label><input type="number" step="any" id="target-iron" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-calcium" class="block text-sm font-medium text-gray-600">Calcium (mg)</label><input type="number" step="any" id="target-calcium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-magnesium" class="block text-sm font-medium text-gray-600">Magnesium (mg)</label><input type="number" step="any" id="target-magnesium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-zinc" class="block text-sm font-medium text-gray-600">Zinc (mg)</label><input type="number" step="any" id="target-zinc" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-potassium" class="block text-sm font-medium text-gray-600">Potassium (mg)</label><input type="number" step="any" id="target-potassium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-sodium" class="block text-sm font-medium text-gray-600">Sodium (mg)</label><input type="number" step="any" id="target-sodium" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-4 border-b pb-2 mb-2">Averaged Minerals</h3></div>
          <div><label for="target-selenium" class="block text-sm font-medium text-gray-600">Selenium (mcg)</label><input type="number" step="any" id="target-selenium" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-iodine" class="block text-sm font-medium text-gray-600">Iodine (mcg)</label><input type="number" step="any" id="target-iodine" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-phosphorus" class="block text-sm font-medium text-gray-600">Phosphorus (mg)</label><input type="number" step="any" id="target-phosphorus" class="w-full p-2 border border-gray-300 rounded-md"></div>

          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-700 pt-4 border-b pb-2 mb-2">Optional Nutrients</h3></div>
          <div><label for="target-omega3" class="block text-sm font-medium text-gray-600">Omega-3 (g)</label><input type="number" step="any" id="target-omega3" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-fiber" class="block text-sm font-medium text-gray-600">Fiber (g)</label><input type="number" step="any" id="target-fiber" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label for="target-choline" class="block text-sm font-medium text-gray-600">Choline (mg)</label><input type="number" step="any" id="target-choline" class="w-full p-2 border border-gray-300 rounded-md"></div>
        </div>

        <div class="mt-8 flex justify-between items-center">
          <button type="button" id="export-targets-json-btn" class="px-6 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 text-sm">Export Targets (JSON)</button>
          <button type="button" id="export-saved-foods-csv-btn" class="px-6 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 text-sm">Export Saved Foods (CSV)</button>
          <button type="button" id="export-all-data-btn" class="px-6 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 text-sm">Export Daily Log (CSV)</button>
          <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">Save Targets</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Food Manager Modal -->
  <div id="food-manager-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-4xl max-h-[90vh] relative">
      <button onclick="closeFoodManager()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Manage Saved Foods</h2>
      <div class="overflow-y-auto max-h-[70vh] pr-4">
        <div id="food-manager-list"></div>
      </div>
    </div>
  </div>

  <!-- Duplicate Food Modal -->
  <div id="duplicate-food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-3xl max-h-[90vh] relative">
      <div id="duplicate-comparison" class="overflow-y-auto max-h-[70vh]"></div>
    </div>
  </div>

  <!-- Blank Food Name Modal -->
  <div id="blank-food-name-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm relative">
      <button onclick="closeBlankFoodNameModal()" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Food Name Required</h2>
      <div id="blank-food-name-prompt" class="text-center">
        <p class="mb-4">The food name is blank. Would you like to save it as "(blank)" or enter a name?</p>
        <div class="flex justify-center gap-4">
          <button id="confirm-blank-name-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Save as (blank)</button>
          <button id="enter-name-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Enter Name</button>
        </div>
      </div>
      <div id="blank-food-name-input-container" class="hidden mt-4">
        <label for="blank-food-name-input" class="block text-sm font-medium text-gray-700 mb-1">Enter New Food Name</label>
        <input type="text" id="blank-food-name-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Unlabeled Snack">
        <div class="flex justify-end gap-4 mt-4">
          <button id="cancel-blank-name-btn" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">Cancel</button>
          <button id="submit-new-food-name-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Submit</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm relative">
        <h2 class="text-xl font-bold mb-4 text-center text-gray-800">Confirm Action</h2>
        <p id="confirmation-message" class="text-gray-700 text-center mb-6"></p>
    
        <div id="prompt-input-container" class="mt-4 hidden">
          <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-1">Enter Value:</label>
          <input type="text" id="prompt-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"/>
        </div>
    
        <div class="flex justify-center gap-4 mt-6">
          <button id="confirm-action-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm</button>
          <button id="cancel-action-btn" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">Cancel</button>
        </div>
      </div>
    </div>

<!-- Toast / Message box -->
  <div id="message-box" class="hidden fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50">
    <p id="message-text"></p>
  </div>
</body>
</html>
